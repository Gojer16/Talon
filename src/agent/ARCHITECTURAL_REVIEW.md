# Architectural Review: Agent README

**Document:** `src/agent/README.md`  
**Reviewer:** Senior Software Architect  
**Date:** February 20, 2026  
**Version Reviewed:** 0.4.0

---

## Executive Summary

This review identifies **8 critical documentation issues** in the Agent README, including severe hallucinations about file sizes, non-existent Zod schemas, and an overstated state machine implementation. The documentation significantly misrepresents the actual implementation complexity.

**Key Findings:**
- üî¥ **4 Hallucinations** - Features/sizes that don't exist
- üü° **4 Ambiguous Areas** - Unclear contracts and missing decisions
- üü¢ **5 Accurate Sections** - Well-documented areas

**Most Critical:** File line counts are off by **20-40x** (claims 21k lines, actual is 539).

---

## üî¥ Critical Issues

### 1. Hallucinated: File Line Counts (Severe)

**Location:** Section 4  
**Severity:** CRITICAL  
**Effort to Fix:** 5 minutes

#### Claim
```markdown
**loop.ts** (21,592 lines)
**prompts.ts** (21,851 lines)
**router.ts** (9,733 lines)
**fallback.ts** (10,012 lines)
**context-guard.ts** (6,346 lines)
```

#### Reality
**Actual Line Counts:**
```bash
$ wc -l src/agent/*.ts
  539 loop.ts
  510 prompts.ts
  262 router.ts
  290 fallback.ts
  179 context-guard.ts
1,780 total
```

**Discrepancy:**
| File | Claimed | Actual | Overstated By |
|------|---------|--------|---------------|
| loop.ts | 21,592 | 539 | **40x** |
| prompts.ts | 21,851 | 510 | **43x** |
| router.ts | 9,733 | 262 | **37x** |
| fallback.ts | 10,012 | 290 | **35x** |
| context-guard.ts | 6,346 | 179 | **35x** |

**Impact:** This suggests the documentation was **generated by AI without verification** against actual code.

#### Risk
- Zero credibility for entire document
- Developers cannot estimate effort
- Suggests all other claims are unverified

#### Recommended Fix
Update immediately:
```markdown
**loop.ts** (540 lines)
- What: Main agent state machine implementation
- Why: Orchestrates the complete AI reasoning cycle

**prompts.ts** (511 lines)
- What: System prompt templates and workspace file loading

**router.ts** (262 lines)
- What: Model routing logic with cost-based selection

**fallback.ts** (290 lines)
- What: Fallback handling with automatic retry

**context-guard.ts** (179 lines)
- What: Context window management and token estimation
```

---

### 2. Hallucinated: Zod Schemas for Data Contracts

**Location:** Section 7  
**Severity:** HIGH  
**Effort to Fix:** 1 hour

#### Claim
> "Schemas used:
> - `LLMMessageSchema`: Zod schema for LLM message format
> - `ToolCallSchema`: Zod schema for tool call requests
> - `AgentConfigSchema`: Zod schema for agent configuration
> - `ProviderConfigSchema`: Zod schema for provider settings"

#### Reality
**Zero Zod schemas exist in the agent module:**

```bash
$ grep -r "z\.object\|ZodSchema\|export.*Schema" src/agent/
# Returns: 0 matches
```

**Actual Types** (TypeScript interfaces only):
```typescript
// src/agent/loop.ts - No Zod, just TypeScript
export interface AgentChunk {
    type: 'thinking' | 'text' | 'tool_call' | 'tool_result' | 'done' | 'error';
    content?: string;
    toolCall?: { id: string; name: string; args: Record<string, unknown> };
    // ...
}

// src/agent/fallback.ts - No validation schema
export interface FallbackResult {
    response: LLMResponse;
    providerId: string;
    model: string;
    attempts: FallbackAttempt[];
    totalLatencyMs: number;
}
```

**Validation Strategy (Actual):**
- TypeScript compile-time checking only
- No runtime validation
- Type assertions: `as LLMMessage`, `as FallbackResult`

#### Risk
- No runtime input validation
- Type safety erased at runtime
- Malformed data can propagate silently

#### Recommended Fix
**Option A (Implement schemas):**
```typescript
// src/agent/schemas.ts
import { z } from 'zod';

export const LLMMessageSchema = z.object({
    role: z.enum(['system', 'user', 'assistant', 'tool']),
    content: z.string(),
});

export const ToolCallSchema = z.object({
    id: z.string(),
    name: z.string(),
    args: z.record(z.unknown()),
});
```

**Option B (Update documentation):**
```markdown
**Validation strategy:**
- ‚ö†Ô∏è TypeScript interfaces only (compile-time validation)
- No runtime Zod schemas implemented
- Type assertions used throughout (`as LLMMessage`)
- TODO: Add Zod schemas for runtime validation
```

---

### 3. Hallucinated: State Machine Implementation

**Location:** Section 3, 6, 10  
**Severity:** HIGH  
**Effort to Fix:** 30 minutes

#### Claim
> "State machine: PLAN‚ÜíDECIDE‚ÜíEXECUTE‚ÜíEVALUATE‚ÜíCOMPRESS‚ÜíRESPOND with guard conditions"  
> "Loop state machine (`idle`‚Üí`thinking`‚Üí`executing`‚Üí`evaluating`‚Üí`compressing`‚Üí`responding`)"

#### Reality
**State type exists but implementation is incomplete:**

**Defined States** (`loop.ts:18-24`):
```typescript
export type LoopState =
    | 'idle'
    | 'thinking'     // Building context, deciding approach
    | 'executing'    // Making LLM call (possibly with tools)
    | 'evaluating'   // Checking if result is complete
    | 'compressing'  // Memory compression
    | 'responding'   // Sending final response
    | 'error';
```

**Actual State Transitions** (from code analysis):
```
idle ‚Üí thinking          ‚úÖ (line 147)
thinking ‚Üí executing     ‚úÖ (line 179)
executing ‚Üí error        ‚úÖ (line 274)
executing ‚Üí evaluating   ‚úÖ (line 423)
evaluating ‚Üí responding  ‚úÖ (line 462)
responding ‚Üí idle        ‚úÖ (line 471)
thinking ‚Üí compressing   ‚úÖ (line 510)
compressing ‚Üí responding ‚úÖ (implied)
```

**Missing:**
- ‚ùå No state transition validation (can jump to any state)
- ‚ùå No guard conditions documented
- ‚ùå No state machine library or formalism
- ‚ùå No invalid transition handling
- ‚ùå No `DECIDE` phase (claimed in docs but not in code)

**Actual Flow:**
```
idle ‚Üí thinking ‚Üí executing ‚Üí [evaluating ‚Üí responding] ‚Üí idle
                         ‚Üò [compressing] ‚Üó
```

**Claimed Flow (not implemented):**
```
PLAN ‚Üí DECIDE ‚Üí EXECUTE ‚Üí EVALUATE ‚Üí COMPRESS ‚Üí RESPOND
```

#### Risk
- Documentation promises formal state machine that doesn't exist
- No protection against invalid state transitions
- "DECIDE" phase mentioned but not implemented

#### Recommended Fix
Update documentation to match reality:
```markdown
**State Machine:**
- States: `idle`, `thinking`, `executing`, `evaluating`, `compressing`, `responding`, `error`
- ‚ö†Ô∏è Informal implementation (no state machine library)
- ‚ö†Ô∏è No transition guards (any state can transition to any)
- ‚ö†Ô∏è "DECIDE" phase not implemented (only in comments)
- Flow: `idle` ‚Üí `thinking` ‚Üí `executing` ‚Üí (`evaluating` ‚Üí `responding`) ‚Üí `idle`
- Compression: Triggered when context window is full
```

---

### 4. Hallucinated: Provider Folder Size

**Location:** Section 4  
**Severity:** MEDIUM  
**Effort to Fix:** 5 minutes

#### Claim
```markdown
**providers/** (directory)
- What: AI provider implementations (OpenAI-compatible, OpenCode)
```
(Implies substantial implementation)

#### Reality
```bash
$ wc -l src/agent/providers/*.ts
  282 openai-compatible.ts
  109 opencode.ts
  391 total
```

**Total provider code: 391 lines** (not the thousands implied by other file claims)

#### Recommended Fix
```markdown
**providers/** (391 lines total)
- `openai-compatible.ts` (282 lines): Base provider for OpenAI, DeepSeek, OpenRouter
- `opencode.ts` (109 lines): Free model provider (no API key required)
```

---

## üü° Ambiguous Areas

### 5. Missing: State Transition Guards

**Location:** Section 6  
**Severity:** MEDIUM

#### Claim
> "State machine: PLAN‚ÜíDECIDE‚ÜíEXECUTE‚ÜíEVALUATE‚ÜíCOMPRESS‚ÜíRESPOND with guard conditions"

#### Reality
**No guard conditions exist:**

```typescript
// src/agent/loop.ts - Direct assignment, no guards
this.state = 'thinking';    // line 147
this.state = 'executing';   // line 179
this.state = 'error';       // line 274
this.state = 'evaluating';  // line 423
this.state = 'responding';  // line 462
this.state = 'idle';        // line 471
```

**Missing:**
- ‚ùå No `setState()` method with validation
- ‚ùå No allowed transition matrix
- ‚ùå No error on invalid transitions
- ‚ùå No state history tracking

#### Question
What happens if code accidentally sets `this.state = 'responding'` from `idle`? **Nothing** - no validation.

#### Recommended Fix
Document the gap:
```markdown
**Guardrails:**
- ‚ö†Ô∏è No state transition guards implemented
- ‚ö†Ô∏è State can be set to any value from any context
- TODO: Add state transition validation
```

---

### 6. Ambiguous: Token Estimation Accuracy

**Location:** Section 6, 8  
**Severity:** MEDIUM

#### Claim
> "Token estimation: ~4 chars/token approximation with message structure overhead"  
> "Token estimation: O(n) over all messages for each LLM call"

#### Reality
**Implementation** (`context-guard.ts:62-73`):
```typescript
export function estimateTokens(text: string): number {
    return Math.ceil(text.length / 4);  // ‚Üê Simple division
}

export function estimateMessagesTokens(
    messages: Array<{ role: string; content: string }>
): number {
    return messages.reduce((total, msg) => {
        const baseTokens = 4;  // ‚Üê Fixed overhead
        const contentTokens = estimateTokens(msg.content);
        return total + baseTokens + contentTokens;
    }, 0);
}
```

**Issues:**
1. **No actual tokenization** - uses character count
2. **Fixed 4 chars/token** - inaccurate for code, non-English
3. **Fixed 4-token overhead** - not based on actual API behavior
4. **No model-specific tokenizers** - different models tokenize differently

**Accuracy Unknown:** No benchmarks comparing estimate vs actual API token counts.

#### Risk
- May underestimate tokens ‚Üí context overflow
- May overestimate ‚Üí waste context window
- Different behavior for code vs prose

#### Recommended Fix
Add accuracy disclaimer:
```markdown
**Token Estimation:**
- ‚ö†Ô∏è Approximate only (~4 chars/token for English prose)
- ‚ö†Ô∏è Not accurate for code, tables, non-English text
- ‚ö†Ô∏è No model-specific tokenization
- Accuracy: Unbenchmarked (may vary ¬±30%)
- TODO: Use `@anthropic-ai/tokenizer` for accurate counts
```

---

### 7. Missing: Cost Tracking Implementation

**Location:** Section 6, 8, 9, 12  
**Severity:** LOW

#### Claim
> "Missing: Cost tracking per provider (planned)"  
> "Missing: Cost tracking per provider/model"  
> "No cost tracking per request (cannot optimize for cost)"

#### Reality
**Correctly identified as missing** - but no implementation plan exists.

**Current State:**
- Model router selects by cost tier (cheap ‚Üí expensive)
- No actual cost calculation
- No per-request cost tracking
- No budget enforcement
- No cost logging

**Usage Tracking (what exists):**
```typescript
// From LLM response only
usage?: {
    promptTokens: number;
    completionTokens: number;
    totalTokens: number;
};
// But no cost = tokens √ó price
```

#### Recommended Fix
Add implementation plan to Technical Debt:
```markdown
**Cost Tracking Implementation Plan:**
1. Add `costPerMillionTokens` to provider config
2. Calculate cost per request: `(promptTokens * promptPrice + completionTokens * completionPrice) / 1M`
3. Log cost with each request
4. Track daily/weekly/monthly totals
5. Add budget alerts (warn at 80%, block at 100%)
```

---

### 8. Ambiguous: Workspace File Caching

**Location:** Section 8, 12  
**Severity:** LOW

#### Claim
> "File system reads: Workspace files loaded on every message"  
> "Cache workspace files with file watcher for changes"

#### Reality
**Actual Implementation** (`prompts.ts`):
```typescript
export function loadSoul(workspaceRoot: string): string {
    return loadWorkspaceFile(workspaceRoot, 'SOUL.md') ?? DEFAULT_SOUL;
}

function loadWorkspaceFile(workspaceRoot: string, file: string): string | null {
    const filePath = resolveWorkspacePath(workspaceRoot, file);
    if (fs.existsSync(filePath)) {
        return fs.readFileSync(filePath, 'utf-8');  // ‚Üê Reads every time
    }
    return null;
}
```

**Called From** (`memory/manager.ts`):
```typescript
buildContext(session: Session): LLMMessage[] {
    const soul = loadSoul(this.workspaceRoot);  // ‚Üê Every message
    const user = loadUser(this.workspaceRoot);
    const identity = loadIdentity(this.workspaceRoot);
    // ...
}
```

**Performance Impact:**
- 3-4 file reads per message
- No caching
- No invalidation strategy

**Why It Works:**
- Files are small (<1KB typically)
- SSDs have fast random reads
- Personal assistant = low QPS

**But Still:** Inefficient for no reason.

#### Recommended Fix
Document trade-off:
```markdown
**Workspace File Loading:**
- Current: Reads files on every message (no cache)
- Rationale: Files are small, SSD fast, low request volume
- Impact: ~1-5ms per message (negligible for personal use)
- TODO: Add caching if latency becomes an issue
```

---

## üü¢ Accurate Sections

The following sections are **well-documented and aligned with implementation**:

### ‚úÖ Section 1: Purpose
- Clear scope boundaries
- Correctly states what agent does NOT handle

### ‚úÖ Section 2: Scope Boundaries
- Accurate dependency list
- Correct ownership boundaries

### ‚úÖ Section 5: Public API (Classes)
- `AgentLoop`, `ModelRouter`, `FallbackRouter` all exist
- Export locations correct
- Provider classes accurately listed

### ‚úÖ Section 8: Failure Modes
- Accurately describes failure cases
- Silent failure risks correctly identified
- Race conditions documented (even if not fully handled)

### ‚úÖ Section 12: Technical Debt
- Honest assessment of weaknesses
- Refactor targets are accurate
- Simplification ideas are valid

---

## üìä Summary Statistics

| Category | Count | Severity |
|----------|-------|----------|
| Critical Hallucinations (üî¥) | 4 | HIGH |
| Ambiguous Areas (üü°) | 4 | MEDIUM |
| Accurate Sections (üü¢) | 5 | - |
| **Total Issues Found** | **8** | - |
| **Documentation Accuracy** | **62%** | (5/8 sections accurate) |

**Line Count Accuracy:** **0%** (all 5 file counts wrong by 35-43x)

---

## üéØ Priority Action Items

### P0 - Immediate (Today)
1. **Fix file line counts** - Currently off by 35-43x
2. **Remove Zod schema claims** or implement schemas

### P1 - High Priority (This Week)
3. **Clarify state machine implementation** - Remove "DECIDE" phase, document actual flow
4. **Add token estimation accuracy disclaimer**
5. **Document missing state transition guards**

### P2 - Medium Priority (This Month)
6. **Add cost tracking implementation plan**
7. **Document workspace file caching trade-off**
8. **Update provider folder description with actual line counts**

---

## üìù Verification Commands

Use these commands to verify fixes:

```bash
# Check actual line counts
wc -l src/agent/*.ts

# Check for Zod schemas (should be 0)
grep -r "z\.object\|ZodSchema" src/agent/ || echo "No Zod schemas (as expected)"

# Check state transitions
grep -n "state =" src/agent/loop.ts

# Check token estimation
grep -A 3 "estimateTokens" src/agent/context-guard.ts

# Check provider line counts
wc -l src/agent/providers/*.ts
```

---

## üîó Related Documents

- [Agent README](src/agent/README.md)
- [Agent Loop](src/agent/loop.ts)
- [Model Router](src/agent/router.ts)
- [Fallback System](src/agent/fallback.ts)
- [Context Guard](src/agent/context-guard.ts)
- [Gateway Architectural Review](src/gateway/ARCHITECTURAL_REVIEW.md)

---

## üìå Comparison with Gateway Review

| Issue | Gateway | Agent |
|-------|---------|-------|
| Hallucinated line counts | ‚ùå No | ‚úÖ **Yes (severe)** |
| Hallucinated Zod schemas | ‚úÖ Yes | ‚úÖ Yes |
| State machine gaps | ‚úÖ Yes | ‚úÖ Yes |
| Missing error codes | ‚úÖ Yes | ‚ö†Ô∏è Partial |
| Accurate failure modes | ‚úÖ Yes | ‚úÖ Yes |
| Overall accuracy | 78% | **62%** |

**Note:** Agent README has **more severe hallucinations** (line counts off by 35-43x vs gateway's accurate counts).

---

**Last Updated:** February 20, 2026  
**Next Review:** After v0.4.1 release  
**Action Required:** **IMMEDIATE** - Line count claims destroy document credibility
